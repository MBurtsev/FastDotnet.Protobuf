### FastDotnet.Protobuf (vendored fork)

This directory contains a **vendored fork** of Google's Protocol Buffers implementation, adapted for **high-throughput .NET workloads** (low allocations, pooling, faster parsing/writing) and for **custom code generation** used by this repository.

- **Original repository**: `https://github.com/protocolbuffers/protobuf`

### Why we forked

In this project we needed:

- **Predictable allocations** (or none) in hot paths (market data, trading loops)
- **Object pooling** for protobuf DTOs (`Rent()/Return()`)
- A **very small and fast** reader/writer tailored to our generated DTOs
- A build flow where protobuf DTOs are generated by **our own generator** (instead of `Grpc.Tools` C# output), with naming and API compatibility requirements

### What we changed (high level)

- **Updated .NET target/runtime to .NET 10 (`net10.0`)** for the generator and integration used by this repository.
- **Fast runtime** in `csharp/src/Google.Protobuf/Fast/…`
  - `IFastMessage` interface for generated messages
  - `ProtoReader` / `ProtoWriter` optimized for our generated code
  - pooling primitives (`PooledObjectBase`, `ObjectPool<T>`, etc.)
- **Custom code generator** in `csharp/src/FastDotnet.Protobuf.CodeGen`
  - consumes `descriptor_set.pb` (from `protoc`) and emits C# DTOs
  - supports nested types flattening, enum naming, safe member names, well-known types helpers (e.g. `Timestamp`)
  - generates **pool-backed** messages with `Rent()/Return()` and **`internal` constructors** to enforce pooling
- **MSBuild-friendly workflow**
  - generation is designed to be run during `dotnet build` (descriptor set + generator)

### Repository structure (relevant parts)

- `csharp/src/Google.Protobuf/` — forked C# runtime with our `Fast/*` additions
- `csharp/src/FastDotnet.Protobuf.CodeGen/` — C# generator used by this repo

### Usage examples

#### 1) Generate DTOs from a descriptor set

First, produce a descriptor set with `protoc` (example flags depend on your project):

```bash
protoc --descriptor_set_out=descriptor_set.pb --include_imports your_api.proto
```

Then run the generator:

```bash
dotnet run --project csharp/src/FastDotnet.Protobuf.CodeGen/FastDotnet.Protobuf.CodeGen.csproj -- \
  descriptor_set.pb out Generated.Namespace --all
```

#### 2) Pooling: Rent/Return messages (generated DTOs)

```csharp
var req = MyRequest.Rent();
try
{
    req.AccountId = "123";
    // ... fill fields ...
}
finally
{
    MyRequest.Return(req);
}
```

#### 3) Fast serialization (no reflection)

```csharp
// Write
var writer = new Google.Protobuf.Fast.Proto.ProtoWriter(bufferWriter);
msg.WriteTo(ref writer);
writer.Flush();

// Read
var reader = new Google.Protobuf.Fast.Proto.ProtoReader(span);
msg.MergeFrom(ref reader);
```

#### 4) gRPC marshalling pattern for pooled messages

```csharp
static Marshaller<MyRequest> RequestMarshaller =
    new Marshaller<MyRequest>(
        (value, ctx) => { /* write via ProtoWriter */ },
        ctx => { var m = MyRequest.Rent(); /* read via ProtoReader */ return m; }
    );
```

### Notes

- This is a **vendored dependency for this repository**, not a general-purpose distribution.
- Update/merge from upstream only when needed and after verifying performance + API compatibility for our generator/runtime.
